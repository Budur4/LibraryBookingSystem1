{% extends "base.html" %} {% block title %}Register{% endblock %} {% block
content %}
<div class="container d-flex justify-content-center align-items-center vh-100">
  <div class="card shadow-lg p-4 rounded-4" style="width: 400px">
    <h2 class="text-center mb-4">Create an Account</h2>

    <form id="registerForm" method="POST" action="{{ url_for('register') }}">
      <!-- Username -->
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input
          name="username"
          type="text"
          class="form-control"
          placeholder="Enter username"
          required
        />
        <div class="form-text text-muted" id="usernameGuide">
          ✅ Choose a unique username (letters, numbers, or underscores)
        </div>
        <div
          id="usernameError"
          style="color: red; font-size: 0.9em; display: none"
        ></div>
      </div>

      <!-- Email -->
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input
          name="email"
          type="email"
          class="form-control"
          placeholder="example@gmail.com"
          required
        />
        <div class="form-text text-muted" id="emailGuide">
          ✅ Format example: example@gmail.com
        </div>
        <div
          id="emailError"
          style="color: red; font-size: 0.9em; display: none"
        ></div>
      </div>

      <!-- Password -->
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input
          name="password"
          type="password"
          class="form-control"
          placeholder="At least 8 characters"
          required
          minlength="8"
        />
        <div class="form-text text-muted" id="passwordGuide">
          ✅ Minimum 8 characters
        </div>
      </div>

      <!-- Confirm Password -->
      <div class="mb-3">
        <label class="form-label">Confirm Password</label>
        <input
          name="confirm_password"
          type="password"
          class="form-control"
          placeholder="Confirm password"
          required
        />
        <div
          id="passwordError"
          style="color: red; font-size: 0.9em; display: none"
        ></div>
      </div>

      <!-- Error from backend -->
      {% if error %}
      <div class="alert alert-danger py-2">{{ error }}</div>
      {% endif %}

      <button type="submit" class="btn btn-primary w-100">Register</button>
    </form>

    <div class="text-center mt-3">
      <p class="mb-0">
        Already have an account?
        <a href="{{ url_for('login') }}" class="text-decoration-none"
          >Login here</a
        >
      </p>
    </div>
  </div>
</div>

<!-- ✅ JavaScript validation -->
<script>
  const form = document.getElementById("registerForm");

  // Username
  const usernameInput = form.querySelector('[name="username"]');
  const usernameError = document.getElementById("usernameError");
  const usernameGuide = document.getElementById("usernameGuide");

  function validateUsername(username) {
    if (username.length < 3)
      return "❌ Username must be at least 3 characters long";
    if (!/^[a-zA-Z0-9_]+$/.test(username))
      return "❌ Only letters, numbers, and underscores are allowed";
    return "";
  }

  usernameInput.addEventListener("input", () => {
    const msg = validateUsername(usernameInput.value);
    usernameError.style.display = msg ? "block" : "none";
    usernameError.textContent = msg;
    usernameGuide.style.display = msg ? "none" : "block";
  });

  // Email + Password validation (same as before)
  const emailInput = form.querySelector('[name="email"]');
  const emailError = document.getElementById("emailError");
  const emailGuide = document.getElementById("emailGuide");
  const passwordInput = form.querySelector('[name="password"]');
  const confirmInput = form.querySelector('[name="confirm_password"]');
  const passwordError = document.getElementById("passwordError");
  const passwordGuide = document.getElementById("passwordGuide");

  function validateEmail(email) {
    if (!email.includes("@")) return "❌ Email must contain @";
    const parts = email.split("@");
    if (parts.length !== 2 || parts[1].length === 0)
      return "❌ Email must contain domain";
    if (!parts[1].includes("."))
      return "❌ Email must contain extension (e.g., .com)";
    return "";
  }

  function validatePasswords(pwd, cpwd) {
    if (pwd !== cpwd) return "❌ Passwords do not match";
    if (pwd.length < 8) return "❌ Password must be at least 8 characters";
    return "";
  }

  emailInput.addEventListener("input", () => {
    const msg = validateEmail(emailInput.value);
    emailError.style.display = msg ? "block" : "none";
    emailError.textContent = msg;
    emailGuide.style.display = msg ? "none" : "block";
  });

  confirmInput.addEventListener("input", () => {
    const msg = validatePasswords(passwordInput.value, confirmInput.value);
    passwordError.style.display = msg ? "block" : "none";
    passwordError.textContent = msg;
    passwordGuide.style.display = msg ? "none" : "block";
  });

  passwordInput.addEventListener("input", () => {
    const msg = validatePasswords(passwordInput.value, confirmInput.value);
    passwordError.style.display = msg ? "block" : "none";
    passwordError.textContent = msg;
    passwordGuide.style.display = msg ? "none" : "block";
  });

  // Form submit validation
  form.addEventListener("submit", (e) => {
    const usernameMsg = validateUsername(usernameInput.value);
    const emailMsg = validateEmail(emailInput.value);
    const pwdMsg = validatePasswords(passwordInput.value, confirmInput.value);

    if (usernameMsg || emailMsg || pwdMsg) {
      e.preventDefault();
      usernameError.style.display = usernameMsg ? "block" : "none";
      usernameError.textContent = usernameMsg || "";
      emailError.style.display = emailMsg ? "block" : "none";
      emailError.textContent = emailMsg || "";
      passwordError.style.display = pwdMsg ? "block" : "none";
      passwordError.textContent = pwdMsg || "";

      if (usernameMsg) usernameInput.focus();
      else if (emailMsg) emailInput.focus();
      else if (pwdMsg) confirmInput.focus();
    }
  });
</script>
{% endblock %}
